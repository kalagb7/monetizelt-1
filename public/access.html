<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#007bff" />
    <title>Monetizelt</title>

    <!-- Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
        rel="stylesheet" />

    <!-- Dynamic icons -->
    <link id="favicon" rel="icon" href="data:," />
    <link id="appleTouchIcon" rel="apple-touch-icon" href="data:," />

    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --primary-light: #e6f2ff;
            --light: #ffffff;
            --dark: #121212;
            --gray: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #6c757d;
            --success: #20bf6b;
            --danger: #ee5253;
            --shadow: 0 15px 30px rgba(0, 123, 255, .15);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--gray);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, .25);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(250%);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                height: 6px;
                opacity: .6;
            }

            50% {
                height: 16px;
                opacity: 1;
            }
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            animation: fadeIn 0.4s ease-out;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .logo-container::after {
            content: '';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            border-radius: 2px;
        }

        .logo-container img {
            width: 70px;
            height: 70px;
            filter: drop-shadow(0 5px 10px rgba(0, 123, 255, .2));
            transition: transform .3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto;
        }

        .logo-container img:hover {
            transform: scale(1.08) rotate(3deg);
        }

        .player-container {
            background-color: var(--light);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
            transition: transform .3s ease, box-shadow .3s ease;
            animation: slideUp 0.5s ease-out 0.1s both;
        }

        .player-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 123, 255, .2);
        }

        .player-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--light);
            padding: 18px 18px 16px 18px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, .12);
        }

        .brand-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .brand {
            font-weight: 900;
            letter-spacing: .4px;
            font-size: 14px;
            opacity: .95;
            user-select: none;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .chip-btn {
            background: rgba(255, 255, 255, .14);
            border: 1px solid rgba(255, 255, 255, .18);
            color: #fff;
            padding: 8px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            font-size: 12px;
            transition: all .2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .chip-btn:hover {
            background: rgba(255, 255, 255, .25);
            transform: translateY(-2px) scale(1.02);
        }

        .chip-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .chip-btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }

        .chip-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .7);
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .access-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            line-height: 1.2;
        }

        .access-row .label {
            font-weight: 700;
            font-size: 13px;
            opacity: .95;
        }

        .product-link {
            font-weight: 800;
            font-size: 13px;
            color: #fff;
            text-decoration: none;
            border-bottom: 1px solid rgba(255, 255, 255, .0);
            transition: all .2s ease;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-link:hover {
            opacity: .95;
            border-bottom-color: rgba(255, 255, 255, .55);
            transform: translateX(2px);
        }

        .id-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .18);
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 12px;
            user-select: none;
            transition: all .2s ease;
        }

        .id-pill:hover {
            background: rgba(0, 0, 0, .30);
        }

        .id-pill .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-weight: 900;
            letter-spacing: .2px;
        }

        .copy-btn {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .18);
            background: rgba(255, 255, 255, .10);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all .2s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex: 0 0 auto;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, .18);
            transform: translateY(-2px) scale(1.05);
        }

        .copy-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .copy-btn svg {
            display: block;
        }

        .player-content {
            padding: 18px;
        }

        /* Skeleton */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: #eef2f7;
            border-radius: 12px;
            border: 1px solid rgba(0, 123, 255, .10);
        }

        .skeleton::after {
            content: "";
            position: absolute;
            top: 0;
            left: -40%;
            width: 40%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .7), transparent);
            animation: shimmer 1.2s infinite;
        }

        .skeleton-stack {
            display: grid;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        .sk-row {
            height: 64px;
        }

        .sk-title {
            height: 14px;
            width: 60%;
            border-radius: 999px;
        }

        .sk-sub {
            height: 10px;
            width: 35%;
            border-radius: 999px;
        }

        .hint {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 700;
            letter-spacing: .2px;
        }

        .error-container {
            background: #fee;
            color: #e44;
            padding: 18px;
            border-radius: 12px;
            margin-top: 14px;
            display: none;
            box-shadow: 0 5px 15px rgba(255, 100, 100, .15);
            text-align: center;
            border: 1px solid rgba(238, 82, 83, .25);
            animation: slideUp 0.4s ease-out;
        }

        .error-container h3 {
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 900;
        }

        /* Media list */
        .section-title {
            font-weight: 900;
            color: var(--primary-dark);
            margin: 8px 0 10px;
            font-size: 13px;
            letter-spacing: .2px;
            text-transform: uppercase;
            opacity: .9;
        }

        .media-list {
            display: grid;
            gap: 10px;
        }

        .media-item {
            display: grid;
            grid-template-columns: 56px 1fr 44px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
            border: 1px solid rgba(0, 123, 255, .12);
            box-shadow: 0 10px 18px rgba(0, 0, 0, .04);
            cursor: pointer;
            transition: all .3s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            animation: slideUp 0.4s ease-out both;
        }

        .media-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .media-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .media-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .media-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .media-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .media-item:hover {
            transform: translateY(-3px) scale(1.01);
            border-color: rgba(0, 123, 255, .25);
            box-shadow: 0 16px 28px rgba(0, 123, 255, .12);
        }

        .media-item:active {
            transform: translateY(-1px) scale(0.99);
        }

        .thumb {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--primary-light);
            border: 1px solid rgba(0, 123, 255, .18);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform .3s ease;
        }

        .media-item:hover .thumb {
            transform: scale(1.05) rotate(2deg);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .meta {
            min-width: 0;
        }

        .meta .t {
            font-weight: 900;
            color: #1d2b3a;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meta .s {
            margin-top: 4px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: rgba(0, 123, 255, .08);
            border: 1px solid rgba(0, 123, 255, .14);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: all .2s ease;
        }

        .media-item:hover .action {
            background: rgba(0, 123, 255, .15);
            transform: scale(1.1);
        }

        .action svg {
            opacity: .95;
            transition: transform .2s ease;
        }

        .media-item:hover .action svg {
            transform: scale(1.1);
        }

        /* Playing animation */
        .eq {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: none;
            gap: 2px;
            align-items: flex-end;
            opacity: .85;
        }

        .eq span {
            width: 3px;
            height: 6px;
            background: var(--primary);
            border-radius: 2px;
            animation: bounce 0.8s infinite ease-in-out;
        }

        .eq span:nth-child(2) {
            animation-delay: .1s;
        }

        .eq span:nth-child(3) {
            animation-delay: .2s;
        }

        .media-item.playing .eq {
            display: flex;
        }

        /* Video player */
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .18);
            margin: 10px 0 14px;
            touch-action: manipulation;
            border: 1px solid rgba(0, 123, 255, .12);
            animation: scaleIn 0.4s ease-out;
        }

        video.custom-video {
            width: 100%;
            display: block;
            background: #000;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 900;
            color: rgba(255, 255, 255, .07);
            pointer-events: none;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 5px;
            white-space: nowrap;
        }

        .video-controls-container {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: linear-gradient(to top, rgba(0, 0, 0, .78) 0%, transparent 100%);
            padding: 10px 12px;
            opacity: 0;
            transition: opacity .25s ease;
        }

        .video-container:hover .video-controls-container,
        .video-container.controls-visible .video-controls-container {
            opacity: 1;
        }

        .video-progress-container {
            width: 100%;
            height: 6px;
            background-color: rgba(255, 255, 255, .18);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height .2s ease;
        }

        .video-progress-container:hover {
            height: 8px;
        }

        .video-progress-bar {
            height: 100%;
            background-color: var(--primary);
            border-radius: 3px;
            width: 0%;
            transition: width .1s linear;
        }

        .video-progress-preview {
            position: absolute;
            top: -28px;
            transform: translateX(-50%);
            padding: 2px 6px;
            border-radius: 6px;
            background: rgba(0, 0, 0, .78);
            color: #fff;
            font-size: 11px;
            pointer-events: none;
            display: none;
        }

        .video-buffered {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(255, 255, 255, .25);
            border-radius: 3px;
            width: 0%;
        }

        .video-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .ctrl-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all .2s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex: 0 0 auto;
        }

        .ctrl-btn:hover {
            background-color: rgba(255, 255, 255, .12);
            transform: scale(1.1);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .video-time {
            color: #fff;
            font-size: 12px;
            margin: 0 8px;
            min-width: 110px;
            text-align: center;
            font-weight: 800;
            opacity: .95;
        }

        .video-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .video-volume-container {
            display: flex;
            align-items: center;
            width: 100px;
        }

        .video-volume-slider {
            width: 70px;
            height: 4px;
            background-color: rgba(255, 255, 255, .2);
            border-radius: 2px;
            cursor: pointer;
            margin-left: 10px;
            position: relative;
            transition: height .2s ease;
        }

        .video-volume-slider:hover {
            height: 6px;
        }

        .video-volume-level {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            width: 100%;
            transition: width .1s ease;
        }

        .selector {
            appearance: none;
            background: rgba(0, 0, 0, .45);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .20);
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 800;
            transition: all .2s ease;
        }

        .selector:hover {
            background: rgba(0, 0, 0, .60);
        }

        .buffering-dot {
            position: absolute;
            left: 12px;
            bottom: 12px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .6);
            box-shadow: 0 0 0 0 rgba(255, 255, 255, .25);
            transform: scale(1);
            pointer-events: none;
        }

        .buffering.active .buffering-dot {
            animation: pulse 1.2s ease-out infinite;
        }

        /* Audio player */
        .audio-player {
            margin: 10px 0 14px;
            padding: 12px;
            border-radius: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
            border: 1px solid rgba(0, 123, 255, .12);
            box-shadow: 0 10px 18px rgba(0, 0, 0, .04);
            display: grid;
            grid-template-columns: 56px 1fr 44px;
            gap: 12px;
            align-items: center;
            animation: scaleIn 0.4s ease-out;
            transition: all .3s ease;
        }

        .audio-player:hover {
            box-shadow: 0 14px 24px rgba(0, 123, 255, .12);
            transform: translateY(-2px);
        }

        .audio-controls {
            display: grid;
            gap: 8px;
            min-width: 0;
        }

        .audio-progress {
            width: 100%;
            height: 6px;
            background: rgba(0, 123, 255, .12);
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            transition: height .2s ease;
        }

        .audio-progress:hover {
            height: 8px;
        }

        .audio-progress .bar {
            height: 100%;
            width: 0%;
            background: var(--primary);
            border-radius: 999px;
            transition: width .1s linear;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 900;
            color: var(--text-secondary);
            letter-spacing: .2px;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 18, .55);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            width: 100%;
            max-width: 520px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, .25);
            overflow: hidden;
            border: 2px solid rgba(0, 123, 255, .22);
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-head {
            padding: 14px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            font-weight: 900;
            border-bottom: 1px solid rgba(255, 255, 255, .15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-body p {
            color: #2b3a4a;
            font-size: 13px;
            line-height: 1.55;
            font-weight: 700;
        }

        .form {
            margin-top: 12px;
            display: grid;
            gap: 10px;
        }

        .field label {
            display: block;
            font-size: 12px;
            font-weight: 900;
            color: #1d2b3a;
            margin-bottom: 6px;
            letter-spacing: .2px;
        }

        .field input {
            width: 100%;
            padding: 12px 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 123, 255, .18);
            outline: none;
            font-weight: 800;
            font-size: 13px;
            transition: all .2s ease;
        }

        .field input:focus {
            border-color: rgba(0, 123, 255, .45);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, .12);
            transform: scale(1.01);
        }

        .modal-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 12px;
            border-radius: 12px;
            border: 2px solid transparent;
            font-weight: 900;
            cursor: pointer;
            transition: all .2s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 13px;
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-ghost {
            background: #fff;
            color: var(--primary);
            border-color: rgba(0, 123, 255, .35);
        }

        .btn-ghost:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-ghost:active {
            transform: translateY(0);
        }

        .modal-error {
            margin-top: 10px;
            display: none;
            padding: 10px 12px;
            border-radius: 12px;
            background: #fee;
            color: #d33;
            font-weight: 900;
            font-size: 12px;
            border: 1px solid rgba(238, 82, 83, .25);
            animation: slideUp 0.3s ease-out;
        }

        /* Drawer */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 18, .55);
            backdrop-filter: blur(4px);
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            z-index: 9998;
            animation: fadeIn 0.3s ease-out;
        }

        .drawer {
            width: 100%;
            max-width: 900px;
            background: #fff;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            box-shadow: 0 -20px 60px rgba(0, 0, 0, .25);
            border: 2px solid rgba(0, 123, 255, .22);
            overflow: hidden;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .drawer-head {
            padding: 14px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .drawer-body {
            padding: 14px 16px 18px;
            overflow: auto;
        }

        .library-grid {
            display: grid;
            gap: 10px;
        }

        .library-item {
            display: grid;
            grid-template-columns: 56px 1fr;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid rgba(0, 123, 255, .12);
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
            transition: all .3s ease;
            animation: slideUp 0.4s ease-out both;
        }

        .library-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .library-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .library-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .library-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 123, 255, .12);
        }

        .library-item .row2 {
            margin-top: 6px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .mini-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 900;
            transition: all .2s ease;
        }

        .mini-link:hover {
            text-decoration: underline;
            transform: translateX(2px);
        }

        .muted {
            color: var(--text-secondary);
            font-weight: 800;
            font-size: 12px;
        }

        @media (max-width:768px) {
            .container {
                padding: 10px;
            }

            .player-content {
                padding: 14px;
            }

            .video-volume-container {
                display: none;
            }

            .video-time {
                min-width: 84px;
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/monetizelt-1.firebasestorage.app/o/Monetizelt.jpg?alt=media&token=c942c3a7-0a4b-42f7-82bc-5cfde360e06e"
                alt="Logo">
        </div>

        <div class="player-container" id="playerContainer">
            <div class="player-header">
                <div class="brand-row">
                    <div class="brand">Monetizelt</div>
                    <div class="header-actions">
                        <button class="chip-btn" id="btnInstall" style="display:none;">
                            <span class="chip-dot"></span>
                            Add to Home Screen
                        </button>
                        <button class="chip-btn" id="btnMyProducts" title="View my products">
                            <span class="chip-dot"></span>
                            My products
                        </button>
                    </div>
                </div>

                <div class="access-row">
                    <div class="label">Access to</div>
                    <a class="product-link" id="productLink" href="#" target="_blank" rel="noopener"
                        style="pointer-events:none;opacity:.95;">
                        ...
                    </a>

                    <span class="id-pill" id="productIdPill" style="display:none;">
                        <button class="copy-btn" id="btnCopyId" aria-label="Copy product id" title="Copy product id">
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <path fill="#fff"
                                    d="M19,21H8A2,2 0 0,1 6,19V7H8V19H19M16,3H5A2,2 0 0,0 3,5V17H5V5H16M21,7H10A2,2 0 0,0 8,9V21A2,2 0 0,0 10,23H21A2,2 0 0,0 23,21V9A2,2 0 0,0 21,7Z" />
                            </svg>
                        </button>
                        <span class="mono" id="productIdText">#—</span>
                    </span>
                </div>
            </div>

            <div class="player-content">
                <div id="skeletonBlock" class="skeleton-stack">
                    <div class="skeleton sk-title"></div>
                    <div class="skeleton sk-sub"></div>
                    <div class="skeleton sk-row"></div>
                    <div class="skeleton sk-row"></div>
                    <div class="skeleton sk-row"></div>
                    <div class="hint">Monetizelt is preparing your access…</div>
                </div>

                <div id="contentContainer" style="display:none;"></div>
            </div>
        </div>

        <div class="error-container" id="errorContainer">
            <h3>Access error</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <!-- Unlock modal -->
    <div class="modal-backdrop" id="unlockBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
            <div class="modal-head">
                <div id="unlockTitle">Unlock your purchase</div>
                <button class="chip-btn" id="btnCloseUnlock" title="Close">
                    Close
                </button>
            </div>
            <div class="modal-body">
                <p>
                    This device is not recognized for this purchase.<br />
                    Enter the <strong>email</strong> used at checkout and your <strong>access code</strong> (sent by
                    email after payment).
                </p>

                <div class="form">
                    <div class="field">
                        <label for="unlockEmail">Email</label>
                        <input id="unlockEmail" type="email" autocomplete="email" placeholder="you@example.com" />
                    </div>

                    <div class="field">
                        <label for="unlockCode">Access code</label>
                        <input id="unlockCode" type="text" autocomplete="one-time-code" placeholder="ABCDE12345" />
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-ghost" id="btnUnlockCancel">Cancel</button>
                        <button class="btn btn-primary" id="btnUnlockSubmit">Unlock</button>
                    </div>

                    <div class="modal-error" id="unlockError"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer: My products -->
    <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
        <div class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
            <div class="drawer-head">
                <div id="drawerTitle">My products</div>
                <button class="chip-btn" id="btnCloseDrawer" title="Close">Close</button>
            </div>
            <div class="drawer-body">
                <div class="muted" style="margin-bottom:10px;">
                    If you bought multiple products, you'll see them here. Open any product to play it and add it to
                    your home screen.
                </div>
                <div id="librarySkeleton" class="skeleton-stack" style="display:none;">
                    <div class="skeleton sk-row"></div>
                    <div class="skeleton sk-row"></div>
                    <div class="skeleton sk-row"></div>
                </div>
                <div id="libraryList" class="library-grid"></div>
            </div>
        </div>
    </div>

    <script>
        /* ===== Content protections ===== */
        window.isSoftwareProduct = false;
        document.addEventListener('contextmenu', e => { if (!window.isSoftwareProduct) e.preventDefault(); });
        document.addEventListener('selectstart', e => { if (!window.isSoftwareProduct) e.preventDefault(); });
        document.addEventListener('dragstart', e => { if (!window.isSoftwareProduct) e.preventDefault(); });
        document.addEventListener('keydown', e => {
            if (!window.isSoftwareProduct) {
                const k = (e.key || '').toLowerCase();
                if ((e.ctrlKey || e.metaKey) && (['s', 'p', 'u'].includes(k))) e.preventDefault();
                if (e.key === 'F12' || ((e.ctrlKey || e.metaKey) && e.shiftKey && k === 'i')) e.preventDefault();
            }
        });

        /* ===== Config ===== */
        const API_BASE = "https://us-central1-monetizelt-1.cloudfunctions.net";
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // UI elements
        const skeletonBlock = document.getElementById('skeletonBlock');
        const contentContainer = document.getElementById('contentContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');

        const productLink = document.getElementById('productLink');
        const productIdPill = document.getElementById('productIdPill');
        const productIdText = document.getElementById('productIdText');
        const btnCopyId = document.getElementById('btnCopyId');

        const btnMyProducts = document.getElementById('btnMyProducts');
        const btnInstall = document.getElementById('btnInstall');

        const unlockBackdrop = document.getElementById('unlockBackdrop');
        const btnCloseUnlock = document.getElementById('btnCloseUnlock');
        const btnUnlockCancel = document.getElementById('btnUnlockCancel');
        const btnUnlockSubmit = document.getElementById('btnUnlockSubmit');
        const unlockEmail = document.getElementById('unlockEmail');
        const unlockCode = document.getElementById('unlockCode');
        const unlockError = document.getElementById('unlockError');

        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const btnCloseDrawer = document.getElementById('btnCloseDrawer');
        const librarySkeleton = document.getElementById('librarySkeleton');
        const libraryList = document.getElementById('libraryList');

        // State
        let deviceFingerprint = null;
        let lastProduct = null;

        /* ===== Device fingerprint (STABLE + MIGRATION) ===== */
        function getCookie(name) {
            const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()[\]\\/+^]/g, '\\$&') + '=([^;]*)'));
            return m ? decodeURIComponent(m[1]) : '';
        }
        function setCookie(name, value, days = 400) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            const secure = (location.protocol === 'https:') ? '; Secure' : '';
            document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Expires=${expires}; Path=/; SameSite=Lax${secure}`;
        }

        async function idbGet(dbName, storeName, key) {
            return new Promise((resolve, reject) => {
                try {
                    const req = indexedDB.open(dbName, 1);
                    req.onerror = () => reject(req.error);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                    };
                    req.onsuccess = () => {
                        const db = req.result;
                        const tx = db.transaction([storeName], 'readonly');
                        const store = tx.objectStore(storeName);
                        const gr = store.get(key);
                        gr.onsuccess = () => resolve(gr.result || null);
                        gr.onerror = () => reject(gr.error);
                    };
                } catch (e) {
                    reject(e);
                }
            });
        }

        async function idbSet(dbName, storeName, key, value) {
            return new Promise((resolve, reject) => {
                try {
                    const req = indexedDB.open(dbName, 1);
                    req.onerror = () => reject(req.error);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                    };
                    req.onsuccess = () => {
                        const db = req.result;
                        const tx = db.transaction([storeName], 'readwrite');
                        const store = tx.objectStore(storeName);
                        store.put(value, key);
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    };
                } catch (e) {
                    reject(e);
                }
            });
        }

        function randomId() {
            try {
                const b = new Uint8Array(16);
                crypto.getRandomValues(b);
                return Array.from(b).map(x => x.toString(16).padStart(2, '0')).join('');
            } catch {
                return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
            }
        }

        async function getOrCreateDeviceFingerprint() {
            const KEY = 'monetizelt_device_fp_v2';
            const LEGACY_KEY = 'monetizelt_device_fp';
            const DB_NAME = 'MonetizeltLocal';
            const STORE = 'kv';

            // 1) preferred v2 localStorage
            try {
                const v2 = localStorage.getItem(KEY);
                if (v2) return v2;
            } catch { }

            // 2) migrate legacy
            try {
                const legacy = localStorage.getItem(LEGACY_KEY);
                if (legacy) {
                    try { localStorage.setItem(KEY, legacy); } catch { }
                    try { await idbSet(DB_NAME, STORE, KEY, legacy); } catch { }
                    setCookie(KEY, legacy);
                    return legacy;
                }
            } catch { }

            // 3) cookie
            const c = getCookie(KEY);
            if (c) {
                try { localStorage.setItem(KEY, c); } catch { }
                try { await idbSet(DB_NAME, STORE, KEY, c); } catch { }
                return c;
            }

            // 4) idb
            try {
                const v = await idbGet(DB_NAME, STORE, KEY);
                if (v) {
                    try { localStorage.setItem(KEY, v); } catch { }
                    setCookie(KEY, v);
                    return v;
                }
            } catch { }

            // 5) create stable id
            const v = "mz_" + randomId();
            try { localStorage.setItem(KEY, v); } catch { }
            try { sessionStorage.setItem(KEY, v); } catch { }
            try { await idbSet(DB_NAME, STORE, KEY, v); } catch { }
            setCookie(KEY, v);

            // keep legacy key too
            try {
                if (!localStorage.getItem(LEGACY_KEY)) localStorage.setItem(LEGACY_KEY, v);
            } catch { }

            return v;
        }

        /* ===== Helpers ===== */
        function showError(msg) {
            skeletonBlock.style.display = 'none';
            contentContainer.style.display = 'none';
            errorMessage.textContent = msg || 'Access denied';
            errorContainer.style.display = 'block';
        }

        function setLoading(on) {
            errorContainer.style.display = 'none';
            skeletonBlock.style.display = on ? 'grid' : 'none';
            contentContainer.style.display = on ? 'none' : 'block';
        }

        function formatTime(s) {
            const sec = Math.max(0, Number(s || 0));
            const m = Math.floor(sec / 60);
            const r = Math.floor(sec % 60);
            return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
        }

        function safeText(s) {
            return String(s || '').replace(/[<>&"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]));
        }

        function inferMediaType(file) {
            const ct = String(file?.contentType || '').toLowerCase();
            const name = String(file?.originalName || '').toLowerCase();
            if (ct.startsWith('video/')) return 'video';
            if (ct.startsWith('audio/')) return 'audio';
            if (/\.(mp4|mov|webm|mkv)$/i.test(name)) return 'video';
            if (/\.(mp3|wav|ogg|flac)$/i.test(name)) return 'audio';
            return 'unknown';
        }

        function posKeyFor(token, fileIndex) {
            return `mz_pos_${token}_${fileIndex}`;
        }

        function setHeaderProductUI({ title, productId, productUrl }) {
            const t = title || 'Product';
            productLink.textContent = t;

            if (productUrl) {
                productLink.href = productUrl;
                productLink.style.pointerEvents = 'auto';
                productLink.style.opacity = '1';
            } else {
                productLink.href = '#';
                productLink.style.pointerEvents = 'none';
                productLink.style.opacity = '.95';
            }

            if (productId) {
                productIdText.textContent = `#${productId}`;
                productIdPill.style.display = 'inline-flex';
            } else {
                productIdPill.style.display = 'none';
            }

            document.title = `Monetizelt — ${t}`;
        }

        async function copyText(text) {
            const s = String(text || '').trim();
            if (!s) return false;
            try {
                await navigator.clipboard.writeText(s);
                return true;
            } catch {
                const ta = document.createElement('textarea');
                ta.value = s;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    return true;
                } catch {
                    document.body.removeChild(ta);
                    return false;
                }
            }
        }

        /* ===== Modal controls ===== */
        function openUnlockModal(prefillEmail = '') {
            unlockError.style.display = 'none';
            unlockError.textContent = '';
            if (prefillEmail) unlockEmail.value = prefillEmail;

            unlockBackdrop.style.display = 'flex';
            unlockBackdrop.setAttribute('aria-hidden', 'false');

            setTimeout(() => unlockEmail.focus(), 0);
        }

        function closeUnlockModal() {
            unlockBackdrop.style.display = 'none';
            unlockBackdrop.setAttribute('aria-hidden', 'true');
        }

        function setUnlockError(msg) {
            unlockError.textContent = msg || 'Unable to unlock.';
            unlockError.style.display = 'block';
        }

        /* ===== Drawer ===== */
        function openDrawer() {
            drawerBackdrop.style.display = 'flex';
            drawerBackdrop.setAttribute('aria-hidden', 'false');
        }
        function closeDrawer() {
            drawerBackdrop.style.display = 'none';
            drawerBackdrop.setAttribute('aria-hidden', 'true');
        }

        btnCloseDrawer.addEventListener('click', closeDrawer);
        drawerBackdrop.addEventListener('click', (e) => { if (e.target === drawerBackdrop) closeDrawer(); });

        btnMyProducts.addEventListener('click', async () => {
            openDrawer();
            await loadBuyerLibrary();
        });

        /* ===== A2HS ===== */
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstall.style.display = 'inline-flex';
        });

        btnInstall.addEventListener('click', async () => {
            if (!deferredPrompt) {
                showToastLikeHint("On iPhone/iPad: tap Share, then 'Add to Home Screen'.");
                return;
            }
            try {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
            } catch { }
            deferredPrompt = null;
            btnInstall.style.display = 'none';
        });

        function showToastLikeHint(text) {
            const el = document.createElement('div');
            el.textContent = text;
            el.style.cssText = 'position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(18,18,18,.88);color:#fff;padding:10px 12px;border-radius:12px;font-weight:900;font-size:12px;z-index:10000;max-width:92vw;text-align:center;animation:slideUp 0.3s ease-out;';
            document.body.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity .25s ease'; }, 1600);
            setTimeout(() => el.remove(), 2000);
        }

        async function setDynamicIconsFromCover(coverUrl) {
            if (!coverUrl) return;

            try {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = coverUrl;

                await new Promise((resolve, reject) => {
                    img.onload = () => resolve(true);
                    img.onerror = reject;
                });

                const size = 256;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                const iw = img.width, ih = img.height;
                const scale = Math.max(size / iw, size / ih);
                const w = iw * scale, h = ih * scale;
                const x = (size - w) / 2, y = (size - h) / 2;
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, size, size);
                ctx.drawImage(img, x, y, w, h);

                const dataUrl = canvas.toDataURL('image/png');

                document.getElementById('appleTouchIcon').setAttribute('href', dataUrl);
                document.getElementById('favicon').setAttribute('href', dataUrl);
            } catch { }
        }

        /* ===== API calls ===== */
        async function apiFetch(path, { method = 'GET', headers = {}, body = null } = {}) {
            const h = new Headers(headers);
            if (deviceFingerprint) h.set('X-Device-Fingerprint', deviceFingerprint);

            const res = await fetch(`${API_BASE}${path}`, { method, headers: h, body });

            const contentType = res.headers.get('content-type') || '';
            const isJson = contentType.includes('application/json');

            if (!isJson) {
                const t = await res.text().catch(() => '');
                throw new Error(t || `Request failed (${res.status})`);
            }

            const data = await res.json();
            if (!res.ok || data?.success === false) {
                const err = new Error(data?.error || `Request failed (${res.status})`);
                err.code = data?.code || null;
                err.httpStatus = res.status;
                err.data = data;
                throw err;
            }
            return data;
        }

        async function tryAccessContent() {
            if (!token) throw new Error('Missing access token.');
            const q = `?token=${encodeURIComponent(token)}&userAgent=${encodeURIComponent(navigator.userAgent)}`;
            return await apiFetch(`/accessContent${q}`, { method: 'GET' });
        }

        async function unlockDeviceWithEmailCode(email, code) {
            return await apiFetch(`/getBuyerLibrary`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: String(email || '').trim(),
                    code: String(code || '').trim(),
                    userAgent: navigator.userAgent,
                    deviceFingerprint: deviceFingerprint || ''
                })
            });
        }

        async function loadBuyerLibrary() {
            if (!deviceFingerprint) return;

            libraryList.innerHTML = '';
            librarySkeleton.style.display = 'grid';

            try {
                const data = await apiFetch(`/getBuyerLibrary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: "",
                        code: "",
                        userAgent: navigator.userAgent,
                        deviceFingerprint: deviceFingerprint || ''
                    })
                });

                const purchases = Array.isArray(data?.purchases) ? data.purchases : [];
                librarySkeleton.style.display = 'none';

                if (!purchases.length) {
                    libraryList.innerHTML = `
                        <div class="muted" style="text-align:center;padding:14px;">
                          No products found for this device yet.<br />
                          Unlock a purchase first (email + access code).
                        </div>
                    `;
                    return;
                }

                libraryList.innerHTML = purchases.map(p => {
                    const title = safeText(p.productTitle || 'Product');
                    const cover = p.coverUrl ? `<img src="${safeText(p.coverUrl)}" alt="">` : '';
                    const when = p.purchasedAt ? new Date(p.purchasedAt).toLocaleString() : '';
                    const accessUrl = p.accessUrl || '#';

                    return `
                        <div class="library-item">
                          <div class="thumb">${cover}</div>
                          <div class="meta">
                            <div class="t">${title}</div>
                            <div class="s">${when ? `Purchased: ${safeText(when)}` : ''}</div>
                            <div class="row2">
                              <a class="mini-link" href="${safeText(accessUrl)}" target="_blank" rel="noopener">Open</a>
                              <span class="muted">•</span>
                              <span class="muted">Open the product, then tap "Add to Home Screen".</span>
                            </div>
                          </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                librarySkeleton.style.display = 'none';
                libraryList.innerHTML = `
                    <div class="muted" style="text-align:center;padding:14px;">
                      Unable to load your products on this device.
                    </div>
                `;
            }
        }

        /* ===== Render product ===== */
        function renderProduct(product) {
            lastProduct = product || {};
            const title = lastProduct.title || 'Product';

            const productId = lastProduct.id || lastProduct.productId || null;
            const productUrl = lastProduct.productUrl || (productId ? `/product.html?productId=${encodeURIComponent(productId)}` : null);

            setHeaderProductUI({ title, productId, productUrl });

            setDynamicIconsFromCover(lastProduct.coverUrl || null);

            const files = Array.isArray(lastProduct.files) ? lastProduct.files : [];
            if (!files.length) {
                contentContainer.innerHTML = `<div class="muted" style="text-align:center;padding:14px;">No media files found.</div>`;
                return;
            }

            contentContainer.innerHTML = `
                <div id="nowPlayingMount"></div>

                <div class="section-title">${(String(lastProduct.subtype || '').toLowerCase() === 'album' || String(lastProduct.subtype || '').toLowerCase() === 'series') ? 'Playlist' : 'Content'}</div>
                <div class="media-list" id="mediaList"></div>
            `;

            const mediaList = document.getElementById('mediaList');

            const coverHtml = lastProduct.coverUrl ? `<img src="${safeText(lastProduct.coverUrl)}" alt="">` : '';

            mediaList.innerHTML = files.map((f, idx0) => {
                const idx = Number(f.index || (idx0 + 1));
                const kind = inferMediaType(f);
                const titleLine = safeText(f.originalName || (kind === 'audio' ? `Track ${idx}` : `Episode ${idx}`));
                const sub = safeText(kind === 'audio' ? 'Audio' : (kind === 'video' ? 'Video' : 'File'));

                const playIcon = (kind === 'audio')
                    ? `<svg width="22" height="22" viewBox="0 0 24 24"><path fill="#007bff" d="M12,3V13.55A4,4 0 1,0 14,17V7H18V3H12Z"/></svg>`
                    : `<svg width="22" height="22" viewBox="0 0 24 24"><path fill="#007bff" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`;

                return `
                    <div class="media-item" data-index="${idx}" data-url="${safeText(f.downloadUrl || '')}" data-kind="${kind}">
                        <div class="thumb">${coverHtml}</div>
                        <div class="meta">
                          <div class="t">${titleLine}</div>
                          <div class="s">${sub}</div>
                        </div>
                        <div class="action">
                          ${playIcon}
                          <div class="eq" aria-hidden="true"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                `;
            }).join('');

            mediaList.querySelectorAll('.media-item').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = Number(el.dataset.index || 1);
                    const url = String(el.dataset.url || '');
                    const kind = String(el.dataset.kind || 'unknown');
                    playSelected({ index: idx, url, kind, title });
                });
            });

            const first = files[0];
            playSelected({
                index: Number(first.index || 1),
                url: String(first.downloadUrl || ''),
                kind: inferMediaType(first),
                title
            }, { autoPlay: false });
        }

        function markPlayingItem(index, isPlaying) {
            const list = document.getElementById('mediaList');
            if (!list) return;
            list.querySelectorAll('.media-item').forEach(it => {
                const idx = Number(it.dataset.index || 0);
                if (idx === Number(index)) it.classList.toggle('playing', !!isPlaying);
                else it.classList.remove('playing');
            });
        }

        function playSelected({ index, url, kind, title }, { autoPlay = false } = {}) {
            const mount = document.getElementById('nowPlayingMount');
            if (!mount) return;
            if (!url) {
                mount.innerHTML = `<div class="muted" style="text-align:center;padding:14px;">Missing file URL.</div>`;
                return;
            }

            if (kind === 'audio') {
                mount.innerHTML = `
                    <div class="audio-player" id="audioPlayer">
                        <div class="thumb">${lastProduct?.coverUrl ? `<img src="${safeText(lastProduct.coverUrl)}" alt="">` : ''}</div>

                        <div class="audio-controls">
                          <div class="meta">
                            <div class="t">${safeText(title || 'Audio')}</div>
                            <div class="s">${safeText(lastProduct?.subtype === 'album' ? `Track #${index}` : `Audio #${index}`)}</div>
                          </div>

                          <div class="audio-progress" id="audioProgress" aria-label="Seek">
                            <div class="bar" id="audioBar"></div>
                          </div>

                          <div class="audio-time">
                            <span id="audioCur">00:00</span>
                            <span id="audioDur">00:00</span>
                          </div>
                        </div>

                        <div class="action" id="audioPlayBtn" title="Play / Pause">
                          <svg width="22" height="22" viewBox="0 0 24 24"><path fill="#007bff" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                          <div class="eq" id="audioEq" aria-hidden="true" style="display:none;"><span></span><span></span><span></span></div>
                        </div>

                        <audio id="audioEl" preload="metadata" crossorigin="anonymous"></audio>
                    </div>
                `;

                initAudioPlayer(index, url, { autoPlay });

            } else if (kind === 'video') {
                mount.innerHTML = `
                    <div class="video-container" id="videoContainer">
                        <video id="videoElement" class="custom-video" playsinline preload="metadata" crossorigin="anonymous" controlslist="nodownload"></video>

                        <div class="buffering-dot" aria-hidden="true"></div>
                        <div class="watermark" id="videoWatermark"></div>

                        <div class="video-controls-container" id="videoControlsContainer">
                          <div class="video-progress-container" id="videoProgressContainer" aria-label="Seek">
                            <div class="video-buffered" id="videoBuffered"></div>
                            <div class="video-progress-bar" id="videoProgressBar"></div>
                            <div class="video-progress-preview" id="videoProgressPreview">00:00</div>
                          </div>

                          <div class="video-controls">
                            <div class="video-left" style="display:flex;align-items:center;gap:6px;">
                              <button class="ctrl-btn" id="videoPlayBtn" aria-label="Play/Pause">
                                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                              </button>
                              <div class="video-time" id="videoTime">00:00 / 00:00</div>
                              <div class="video-volume-container">
                                <button class="ctrl-btn" id="videoMuteBtn" aria-label="Mute/Unmute">
                                  <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
                                </button>
                                <div class="video-volume-slider" id="videoVolumeSlider">
                                  <div class="video-volume-level" id="videoVolumeLevel"></div>
                                </div>
                              </div>
                            </div>

                            <div class="video-right">
                              <select id="speedSelect" class="selector" title="Speed">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                              </select>

                              <button class="ctrl-btn" id="pipBtn" title="Picture in Picture">
                                <svg width="22" height="22" viewBox="0 0 24 24"><path fill="#fff" d="M21,3A2,2 0 0,1 23,5V19A2,2 0 0,1 21,21H3A2,2 0 0,1 1,19V5A2,2 0 0,1 3,3H21M21,5H3V15H21V5M19,12H13V9H19V12Z"/></svg>
                              </button>

                              <button class="ctrl-btn" id="videoFullscreenBtn" aria-label="Fullscreen">
                                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M5,5H10V7H7V10H5V5M19,5V10H17V7H14V5H19M5,19V14H7V17H10V19H5M19,19H14V17H17V14H19V19Z"/></svg>
                              </button>
                            </div>
                          </div>
                        </div>
                    </div>
                `;

                initVideoPlayer(index, url, title, { autoPlay });
            } else {
                mount.innerHTML = `<div class="muted" style="text-align:center;padding:14px;">Unsupported file type.</div>`;
            }
        }

        function initAudioPlayer(fileIndex, src, { autoPlay = false } = {}) {
            const audio = document.getElementById('audioEl');
            const playBtn = document.getElementById('audioPlayBtn');
            const progress = document.getElementById('audioProgress');
            const bar = document.getElementById('audioBar');
            const cur = document.getElementById('audioCur');
            const dur = document.getElementById('audioDur');

            audio.src = src;

            const key = posKeyFor(token, fileIndex);

            function setIcon(paused) {
                playBtn.innerHTML = paused
                    ? `<svg width="22" height="22" viewBox="0 0 24 24"><path fill="#007bff" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                       <div class="eq" id="audioEq" aria-hidden="true" style="display:none;"><span></span><span></span><span></span></div>`
                    : `<svg width="22" height="22" viewBox="0 0 24 24"><path fill="#007bff" d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg>
                       <div class="eq" id="audioEq" aria-hidden="true" style="display:flex;"><span></span><span></span><span></span></div>`;
            }

            function update() {
                const d = audio.duration || 0;
                const t = audio.currentTime || 0;
                cur.textContent = formatTime(t);
                dur.textContent = formatTime(d);
                bar.style.width = d ? `${(t / d) * 100}%` : '0%';
                markPlayingItem(fileIndex, !audio.paused);
            }

            playBtn.addEventListener('click', async () => {
                try {
                    if (audio.paused) {
                        await audio.play();
                        setIcon(false);
                    } else {
                        audio.pause();
                        setIcon(true);
                    }
                } catch { }
            });

            audio.addEventListener('timeupdate', () => {
                update();
                try { localStorage.setItem(key, String(audio.currentTime || 0)); } catch { }
            });

            audio.addEventListener('loadedmetadata', () => {
                const saved = parseFloat(localStorage.getItem(key) || '');
                if (!isNaN(saved) && saved > 0 && saved < (audio.duration || 1)) audio.currentTime = saved;
                update();
                if (autoPlay) {
                    audio.play().then(() => setIcon(false)).catch(() => setIcon(true));
                } else {
                    setIcon(true);
                }
            });

            audio.addEventListener('play', () => { setIcon(false); update(); });
            audio.addEventListener('pause', () => { setIcon(true); update(); });
            audio.addEventListener('ended', () => {
                setIcon(true);
                markPlayingItem(fileIndex, false);
            });

            progress.addEventListener('click', (e) => {
                const rect = progress.getBoundingClientRect();
                const r = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));
                if (audio.duration) audio.currentTime = r * audio.duration;
            });

            setIcon(true);
            update();
        }

        function initVideoPlayer(fileIndex, src, title, { autoPlay = false } = {}) {
            const video = document.getElementById('videoElement');
            const videoContainer = document.getElementById('videoContainer');
            const controlsContainer = document.getElementById('videoControlsContainer');
            const playBtn = document.getElementById('videoPlayBtn');
            const progressBar = document.getElementById('videoProgressBar');
            const progressContainer = document.getElementById('videoProgressContainer');
            const preview = document.getElementById('videoProgressPreview');
            const bufferedBar = document.getElementById('videoBuffered');
            const timeDisplay = document.getElementById('videoTime');
            const volumeSlider = document.getElementById('videoVolumeSlider');
            const volumeLevel = document.getElementById('videoVolumeLevel');
            const muteBtn = document.getElementById('videoMuteBtn');
            const fullscreenBtn = document.getElementById('videoFullscreenBtn');
            const speedSelect = document.getElementById('speedSelect');
            const pipBtn = document.getElementById('pipBtn');

            video.src = src;

            const key = posKeyFor(token, fileIndex);

            const volKey = 'mz_video_vol';
            let savedVol = parseFloat(localStorage.getItem(volKey));
            if (isNaN(savedVol)) savedVol = 1;
            video.volume = savedVol;
            volumeLevel.style.width = `${video.volume * 100}%`;

            function setPlayIcon(paused) {
                playBtn.innerHTML = paused
                    ? `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`
                    : `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg>`;
            }

            function updateVolumeIcon() {
                if (video.volume === 0) {
                    muteBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z"/></svg>`;
                } else if (video.volume < 0.5) {
                    muteBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M5,9V15H9L14,20V4L9,9M18.5,12C18.5,10.23 17.5,8.71 16,7.97V16C17.5,15.29 18.5,13.76 18.5,12Z"/></svg>`;
                } else {
                    muteBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>`;
                }
            }

            updateVolumeIcon();
            video.playbackRate = parseFloat(speedSelect.value || '1');

            function updateProgress() {
                if (!video.duration) return;
                const percent = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${percent}%`;
                timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;

                try {
                    if (video.buffered.length) {
                        const end = video.buffered.end(video.buffered.length - 1);
                        bufferedBar.style.width = `${Math.min(100, (end / video.duration) * 100)}%`;
                    }
                } catch { }
            }

            function toggleFullscreen() {
                if (document.fullscreenElement) document.exitFullscreen();
                else videoContainer.requestFullscreen().catch(() => { });
            }

            function togglePlay() {
                if (video.paused) {
                    video.play().then(() => setPlayIcon(false)).catch(() => { });
                } else {
                    video.pause();
                    setPlayIcon(true);
                }
            }

            playBtn.addEventListener('click', togglePlay);
            video.addEventListener('click', togglePlay);

            videoContainer.addEventListener('dblclick', () => toggleFullscreen());
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            function seekAt(clientX) {
                const rect = progressContainer.getBoundingClientRect();
                const ratio = Math.min(1, Math.max(0, (clientX - rect.left) / rect.width));
                if (video.duration) video.currentTime = ratio * video.duration;
            }

            let isScrubbing = false;
            progressContainer.addEventListener('mousedown', e => { isScrubbing = true; seekAt(e.clientX); });
            window.addEventListener('mousemove', e => { if (isScrubbing) seekAt(e.clientX); });
            window.addEventListener('mouseup', () => { isScrubbing = false; });

            progressContainer.addEventListener('mousemove', e => {
                const rect = progressContainer.getBoundingClientRect();
                const ratio = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));
                if (video.duration) {
                    preview.style.display = 'block';
                    preview.style.left = `${ratio * 100}%`;
                    preview.textContent = formatTime(ratio * video.duration);
                }
            });
            progressContainer.addEventListener('mouseleave', () => { preview.style.display = 'none'; });

            volumeSlider.addEventListener('click', e => {
                const rect = volumeSlider.getBoundingClientRect();
                const nv = (e.clientX - rect.left) / rect.width;
                video.volume = Math.min(1, Math.max(0, nv));
                volumeLevel.style.width = `${video.volume * 100}%`;
                localStorage.setItem(volKey, String(video.volume));
                updateVolumeIcon();
            });

            muteBtn.addEventListener('click', () => {
                if (video.volume > 0) {
                    video.dataset.lastVolume = String(video.volume);
                    video.volume = 0;
                } else {
                    video.volume = parseFloat(video.dataset.lastVolume) || 1;
                }
                volumeLevel.style.width = `${video.volume * 100}%`;
                localStorage.setItem(volKey, String(video.volume));
                updateVolumeIcon();
            });

            let hideTo;
            function showControls() {
                videoContainer.classList.add('controls-visible');
                controlsContainer.style.opacity = '1';
            }
            function scheduleHide() {
                clearTimeout(hideTo);
                hideTo = setTimeout(() => {
                    if (!video.paused) controlsContainer.style.opacity = '0';
                }, 2500);
            }
            videoContainer.addEventListener('mousemove', () => { showControls(); scheduleHide(); });
            video.addEventListener('play', () => { showControls(); scheduleHide(); setPlayIcon(false); markPlayingItem(fileIndex, true); });
            video.addEventListener('pause', () => { clearTimeout(hideTo); controlsContainer.style.opacity = '1'; setPlayIcon(true); markPlayingItem(fileIndex, false); });

            function setBuffering(on) { videoContainer.classList.toggle('buffering', !!on); }
            video.addEventListener('waiting', () => setBuffering(true));
            video.addEventListener('playing', () => setBuffering(false));

            if (!('pictureInPictureEnabled' in document)) pipBtn.style.display = 'none';
            pipBtn.addEventListener('click', async () => {
                try {
                    if (document.pictureInPictureElement) await document.exitPictureInPicture();
                    else await video.requestPictureInPicture();
                } catch { }
            });

            speedSelect.addEventListener('change', () => { video.playbackRate = parseFloat(speedSelect.value || '1'); });

            video.addEventListener('loadedmetadata', () => {
                timeDisplay.textContent = `00:00 / ${formatTime(video.duration)}`;

                const saved = parseFloat(localStorage.getItem(key) || '');
                if (!isNaN(saved) && saved > 0 && saved < (video.duration || 1)) video.currentTime = saved;

                updateProgress();

                if (autoPlay) {
                    video.play().then(() => setPlayIcon(false)).catch(() => setPlayIcon(true));
                } else {
                    setPlayIcon(true);
                }
            });

            video.addEventListener('timeupdate', () => {
                updateProgress();
                try { localStorage.setItem(key, String(video.currentTime || 0)); } catch { }
            });

            video.addEventListener('ended', () => {
                setPlayIcon(true);
                progressBar.style.width = '0%';
                markPlayingItem(fileIndex, false);
            });

            document.addEventListener('keydown', (e) => {
                if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
                if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
                else if (e.code === 'ArrowLeft') { e.preventDefault(); video.currentTime = Math.max(0, (video.currentTime || 0) - 5); }
                else if (e.code === 'ArrowRight') { e.preventDefault(); video.currentTime = Math.min(video.duration || 1, (video.currentTime || 0) + 5); }
                else if (e.key === 'f' || e.key === 'F') { e.preventDefault(); toggleFullscreen(); }
            });

            video.addEventListener('contextmenu', e => e.preventDefault());
        }

        /* ===== Unlock flow ===== */
        btnCloseUnlock.addEventListener('click', closeUnlockModal);
        btnUnlockCancel.addEventListener('click', closeUnlockModal);
        unlockBackdrop.addEventListener('click', (e) => { if (e.target === unlockBackdrop) closeUnlockModal(); });

        btnUnlockSubmit.addEventListener('click', async () => {
            unlockError.style.display = 'none';
            btnUnlockSubmit.disabled = true;

            try {
                const email = String(unlockEmail.value || '').trim();
                const code = String(unlockCode.value || '').trim();

                if (!email || !email.includes('@')) {
                    setUnlockError('Please enter a valid email.');
                    return;
                }
                if (!code || code.length < 6) {
                    setUnlockError('Please enter your access code.');
                    return;
                }

                await unlockDeviceWithEmailCode(email, code);

                closeUnlockModal();
                setLoading(true);
                const data = await tryAccessContent();
                setLoading(false);
                renderProduct(data.product || {});
                await loadBuyerLibrary();

            } catch (e) {
                setUnlockError(e.message || 'Unlock failed.');
            } finally {
                btnUnlockSubmit.disabled = false;
            }
        });

        /* ===== Copy product id ===== */
        btnCopyId.addEventListener('click', async () => {
            const txt = (productIdText.textContent || '').replace(/^#/, '').trim();
            if (!txt || txt === '—') return;
            const ok = await copyText(txt);
            if (ok) showToastLikeHint('Copied');
        });

        /* ===== Boot ===== */
        async function boot() {
            try {
                if (!token) {
                    showError('Missing access token.');
                    return;
                }

                setLoading(true);

                deviceFingerprint = await getOrCreateDeviceFingerprint();

                try {
                    const data = await tryAccessContent();
                    setLoading(false);
                    renderProduct(data.product || {});

                    loadBuyerLibrary().catch(() => { });

                } catch (e) {
                    setLoading(false);

                    const msg = String(e.message || '');
                    const isDeviceBlocked =
                        msg.toLowerCase().includes('device') ||
                        msg.toLowerCase().includes('verified device') ||
                        msg.toLowerCase().includes('purchase device') ||
                        String(e.code || '') === 'permission_denied';

                    if (isDeviceBlocked) {
                        openUnlockModal('');
                        contentContainer.style.display = 'none';
                        skeletonBlock.style.display = 'grid';
                    } else {
                        showError(e.message || 'Access denied.');
                    }
                }
            } catch (e) {
                showError(e.message || 'Unexpected error.');
            }
        }

        document.addEventListener('DOMContentLoaded', boot);
    </script>
</body>

</html>